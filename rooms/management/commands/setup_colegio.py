"""
Comando de gesti√≥n para configurar el Colegio Clara Brincefield.

Este comando elimina todas las salas existentes y crea nuevas salas
y equipamiento apropiado para un colegio.
"""

from django.core.management.base import BaseCommand
from django.contrib.auth import get_user_model
from rooms.models import Room
import logging

User = get_user_model()
logger = logging.getLogger(__name__)


class Command(BaseCommand):
    help = 'Configura salas y equipamiento para el Colegio Clara Brincefield'
    
    def add_arguments(self, parser):
        parser.add_argument(
            '--delete-existing',
            action='store_true',
            help='Eliminar todas las salas existentes antes de crear las nuevas',
        )
    
    def handle(self, *args, **options):
        """Ejecutar el comando para configurar el colegio."""
        
        self.stdout.write(
            self.style.SUCCESS('üè´ Configurando Colegio Clara Brincefield...')
        )
        
        # Eliminar salas existentes si se especifica
        if options['delete_existing']:
            deleted_count = Room.objects.all().count()
            Room.objects.all().delete()
            self.stdout.write(
                self.style.WARNING(f'‚úÖ Eliminadas {deleted_count} salas existentes')
            )
        
        # Obtener usuario admin para asignar como creador
        admin_user = None
        try:
            admin_user = User.objects.filter(is_superuser=True).first()
        except:
            pass
        
        # Datos de salas y equipamiento para el colegio
        rooms_data = [
            # Aulas principales
            {
                'name': 'Aula 1A - Primaria',
                'description': 'Aula principal para estudiantes de primer grado. Equipada con mobiliario adaptado para ni√±os y materiales did√°cticos b√°sicos.',
                'capacity': 25,
                'equipment': 'Pizarra acr√≠lica, proyector, computadora, sistema de sonido, estantes para libros, mobiliario infantil',
                'location': 'Edificio Principal - Primer Piso - Ala Este',
                'room_type': 'aula',
                'opening_time': '07:00',
                'closing_time': '18:00',
                'allowed_roles': 'admin,profesor'
            },
            {
                'name': 'Aula 2B - Primaria',
                'description': 'Aula para estudiantes de segundo grado con enfoque en matem√°ticas y ciencias b√°sicas.',
                'capacity': 25,
                'equipment': 'Pizarra digital interactiva, proyector, tablets educativas, manipulativos matem√°ticos, c√°mara de documentos',
                'location': 'Edificio Principal - Primer Piso - Ala Oeste',
                'room_type': 'aula',
                'opening_time': '07:00',
                'closing_time': '18:00',
                'allowed_roles': 'admin,profesor'
            },
            {
                'name': 'Aula 6A - Primaria Superior',
                'description': 'Aula para estudiantes de sexto grado, preparaci√≥n para secundaria.',
                'capacity': 30,
                'equipment': 'Pizarra inteligente, proyector HD, laptops, impresora, biblioteca de aula, microscopios b√°sicos',
                'location': 'Edificio Principal - Segundo Piso - Ala Norte',
                'room_type': 'aula',
                'opening_time': '07:00',
                'closing_time': '18:00',
                'allowed_roles': 'admin,profesor'
            },
            {
                'name': 'Aula 7A - Secundaria',
                'description': 'Aula principal para estudiantes de s√©ptimo grado, transici√≥n a educaci√≥n secundaria.',
                'capacity': 32,
                'equipment': 'Sistema audiovisual completo, laptops, pizarra digital, conexi√≥n a internet de alta velocidad',
                'location': 'Edificio Secundaria - Primer Piso - Ala Central',
                'room_type': 'aula',
                'opening_time': '07:00',
                'closing_time': '19:00',
                'allowed_roles': 'admin,profesor'
            },
            {
                'name': 'Aula 10B - Secundaria',
                'description': 'Aula para estudiantes de d√©cimo grado con enfoque en preparaci√≥n universitaria.',
                'capacity': 35,
                'equipment': 'Proyector 4K, sistema de conferencias, laptops individuales, impresora 3D b√°sica, calculadoras cient√≠ficas',
                'location': 'Edificio Secundaria - Segundo Piso - Ala Sur',
                'room_type': 'aula',
                'opening_time': '07:00',
                'closing_time': '19:00',
                'allowed_roles': 'admin,profesor'
            },
            
            # Laboratorios
            {
                'name': 'Laboratorio de Ciencias - Qu√≠mica',
                'description': 'Laboratorio especializado en qu√≠mica con equipamiento de seguridad completo y reactivos b√°sicos.',
                'capacity': 24,
                'equipment': 'Mesas de laboratorio con agua y gas, campana extractora, microscopios √≥pticos, balanzas anal√≠ticas, material de vidrio, reactivos b√°sicos, kit de primeros auxilios',
                'location': 'Edificio Ciencias - Primer Piso',
                'room_type': 'laboratorio_ciencias',
                'opening_time': '07:00',
                'closing_time': '17:00',
                'allowed_roles': 'admin,profesor'
            },
            {
                'name': 'Laboratorio de Ciencias - Biolog√≠a',
                'description': 'Laboratorio de biolog√≠a con equipamiento para observaci√≥n y experimentaci√≥n.',
                'capacity': 28,
                'equipment': 'Microscopios binoculares, estereoscopios, modelos anat√≥micos, terrarios, acuarios, esqueletos did√°cticos, l√°minas histol√≥gicas',
                'location': 'Edificio Ciencias - Segundo Piso',
                'room_type': 'laboratorio_ciencias',
                'opening_time': '07:00',
                'closing_time': '17:00',
                'allowed_roles': 'admin,profesor'
            },
            {
                'name': 'Laboratorio de Inform√°tica 1',
                'description': 'Laboratorio principal de computaci√≥n con equipos de √∫ltima generaci√≥n.',
                'capacity': 30,
                'equipment': '30 computadoras de escritorio, servidor local, proyector, pizarra digital, impresora l√°ser, esc√°ner, kit de rob√≥tica b√°sica',
                'location': 'Edificio Tecnolog√≠a - Primer Piso',
                'room_type': 'laboratorio_informatica',
                'opening_time': '07:00',
                'closing_time': '19:00',
                'allowed_roles': 'admin,profesor,estudiante'
            },
            {
                'name': 'Laboratorio de Inform√°tica 2 - Rob√≥tica',
                'description': 'Laboratorio especializado en rob√≥tica y programaci√≥n avanzada.',
                'capacity': 20,
                'equipment': 'Laptops de alto rendimiento, kits de rob√≥tica LEGO Mindstorms, Arduino, Raspberry Pi, impresora 3D profesional, soldadores, mult√≠metros',
                'location': 'Edificio Tecnolog√≠a - Segundo Piso',
                'room_type': 'laboratorio_informatica',
                'opening_time': '07:00',
                'closing_time': '19:00',
                'allowed_roles': 'admin,profesor'
            },
            
            # Espacios especiales
            {
                'name': 'Biblioteca Clara Brincefield',
                'description': 'Biblioteca principal del colegio con zona de estudio silencioso y recursos digitales.',
                'capacity': 50,
                'equipment': 'Cat√°logo digital, computadoras de consulta, impresora, scanner, proyector para presentaciones, zona de lectura c√≥moda',
                'location': 'Edificio Central - Primer Piso',
                'room_type': 'biblioteca',
                'opening_time': '07:00',
                'closing_time': '20:00',
                'allowed_roles': 'admin,profesor,estudiante'
            },
            {
                'name': 'Auditorio Principal',
                'description': 'Auditorio para eventos, conferencias y presentaciones institucionales.',
                'capacity': 200,
                'equipment': 'Sistema de sonido profesional, proyectores de alta definici√≥n, iluminaci√≥n esc√©nica, micr√≥fono inal√°mbrico, c√°maras de video',
                'location': 'Edificio Central - Planta Baja',
                'room_type': 'auditorio',
                'opening_time': '07:00',
                'closing_time': '21:00',
                'allowed_roles': 'admin'
            },
            {
                'name': 'Sala de Profesores',
                'description': 'Espacio privado para reuniones del personal docente y planificaci√≥n acad√©mica.',
                'capacity': 25,
                'equipment': 'Mesa de reuniones, proyector, laptops institucionales, impresora, cafetera, casilleros personales',
                'location': 'Edificio Administrativo - Segundo Piso',
                'room_type': 'sala_profesores',
                'opening_time': '06:30',
                'closing_time': '19:00',
                'allowed_roles': 'admin,profesor'
            },
            {
                'name': 'Sala de Reuniones - Direcci√≥n',
                'description': 'Sala de reuniones para la direcci√≥n acad√©mica y administrativa.',
                'capacity': 12,
                'equipment': 'Mesa ejecutiva, sistema de videoconferencias, proyector, laptops, tel√©fono de conferencias',
                'location': 'Edificio Administrativo - Segundo Piso',
                'room_type': 'sala_reunion',
                'opening_time': '07:00',
                'closing_time': '18:00',
                'allowed_roles': 'admin'
            },
            
            # Equipamiento m√≥vil/recursos
            {
                'name': 'Carrito de Laptops - Set A',
                'description': 'Conjunto de 25 laptops educativas con carrito de carga para uso en cualquier aula.',
                'capacity': 1,
                'equipment': '25 laptops educativas, carrito con sistema de carga, router WiFi m√≥vil, cables y accesorios',
                'location': 'Dep√≥sito de Tecnolog√≠a - Edificio Principal',
                'room_type': 'equipamiento',
                'opening_time': '07:00',
                'closing_time': '18:00',
                'allowed_roles': 'admin,profesor'
            },
            {
                'name': 'Carrito de Tablets - Set B',
                'description': 'Conjunto de 30 tablets educativas para actividades interactivas.',
                'capacity': 1,
                'equipment': '30 tablets Android educativas, aplicaciones pedag√≥gicas, carrito con carga inal√°mbrica, fundas protectoras',
                'location': 'Dep√≥sito de Tecnolog√≠a - Edificio Principal',
                'room_type': 'equipamiento',
                'opening_time': '07:00',
                'closing_time': '18:00',
                'allowed_roles': 'admin,profesor'
            },
            {
                'name': 'Videoproyector Port√°til - VP001',
                'description': 'Proyector de alta definici√≥n para presentaciones en cualquier espacio.',
                'capacity': 1,
                'equipment': 'Proyector HD, cables HDMI y VGA, control remoto, estuche de transporte, tr√≠pode',
                'location': 'Dep√≥sito Audiovisual - Edificio Central',
                'room_type': 'equipamiento',
                'opening_time': '07:00',
                'closing_time': '19:00',
                'allowed_roles': 'admin,profesor'
            },
            {
                'name': 'Videoproyector Port√°til - VP002',
                'description': 'Segundo proyector m√≥vil de respaldo para eventos simult√°neos.',
                'capacity': 1,
                'equipment': 'Proyector HD, cables m√∫ltiples, control remoto, estuche de transporte, tr√≠pode',
                'location': 'Dep√≥sito Audiovisual - Edificio Central',
                'room_type': 'equipamiento',
                'opening_time': '07:00',
                'closing_time': '19:00',
                'allowed_roles': 'admin,profesor'
            },
            {
                'name': 'Kit de Microscopios - Ciencias',
                'description': 'Conjunto de microscopios port√°tiles para pr√°cticas de laboratorio.',
                'capacity': 1,
                'equipment': '15 microscopios √≥pticos, l√°minas preparadas, porta y cubreobjetos, malet√≠n de transporte',
                'location': 'Laboratorio de Biolog√≠a - Almac√©n',
                'room_type': 'equipamiento',
                'opening_time': '07:00',
                'closing_time': '17:00',
                'allowed_roles': 'admin,profesor'
            },
            {
                'name': 'Kit de Rob√≥tica Educativa - LEGO',
                'description': 'Kits de rob√≥tica LEGO Mindstorms para clases de tecnolog√≠a.',
                'capacity': 1,
                'equipment': '10 kits LEGO Mindstorms EV3, sensores adicionales, pistas de competencia, manual de actividades',
                'location': 'Laboratorio de Rob√≥tica - Almac√©n',
                'room_type': 'equipamiento',
                'opening_time': '07:00',
                'closing_time': '19:00',
                'allowed_roles': 'admin,profesor'
            },
            {
                'name': 'C√°mara de Documentos - CD001',
                'description': 'C√°mara para mostrar documentos y objetos en tiempo real.',
                'capacity': 1,
                'equipment': 'C√°mara de documentos con zoom, conexi√≥n USB, software incluido, base articulada',
                'location': 'Dep√≥sito Audiovisual - Edificio Central',
                'room_type': 'equipamiento',
                'opening_time': '07:00',
                'closing_time': '18:00',
                'allowed_roles': 'admin,profesor'
            },
            {
                'name': 'Sistema de Sonido Port√°til',
                'description': 'Equipo de sonido m√≥vil para eventos al aire libre y presentaciones.',
                'capacity': 1,
                'equipment': 'Altavoces amplificados, micr√≥fonos inal√°mbricos, mezcladora, cables, bater√≠a port√°til',
                'location': 'Dep√≥sito Audiovisual - Edificio Central',
                'room_type': 'equipamiento',
                'opening_time': '07:00',
                'closing_time': '20:00',
                'allowed_roles': 'admin,profesor'
            }
        ]
        
        # Crear salas y equipamiento
        created_count = 0
        for room_data in rooms_data:
            # Convertir horarios string a objetos time
            from datetime import time
            
            opening_time = time(*map(int, room_data['opening_time'].split(':')))
            closing_time = time(*map(int, room_data['closing_time'].split(':')))
            
            room = Room.objects.create(
                name=room_data['name'],
                description=room_data['description'],
                capacity=room_data['capacity'],
                equipment=room_data['equipment'],
                location=room_data['location'],
                room_type=room_data['room_type'],
                opening_time=opening_time,
                closing_time=closing_time,
                allowed_roles=room_data['allowed_roles'],
                hourly_rate=0.00,  # Gratis para el colegio
                is_active=True,
                created_by=admin_user
            )
            
            created_count += 1
            self.stdout.write(f'‚úÖ Creado: {room.name}')
        
        # Resumen final
        self.stdout.write('\n' + '='*60)
        self.stdout.write(
            self.style.SUCCESS(
                f'üéâ ¬°Configuraci√≥n completada para el Colegio Clara Brincefield!'
            )
        )
        self.stdout.write(f'üìä Total de salas/equipamiento creado: {created_count}')
        
        # Estad√≠sticas por tipo
        stats = {}
        for room_type, room_name in Room.ROOM_TYPE_CHOICES:
            count = Room.objects.filter(room_type=room_type).count()
            if count > 0:
                stats[room_name] = count
        
        self.stdout.write('\nüìà Distribuci√≥n por tipo:')
        for tipo, cantidad in stats.items():
            self.stdout.write(f'   ‚Ä¢ {tipo}: {cantidad}')
        
        self.stdout.write('\nüè´ El sistema est√° listo para ser usado en el Colegio Clara Brincefield')
        self.stdout.write('üí° Recuerda que el campo "valor" est√° oculto en los formularios pero se mantiene en el modelo')
        self.stdout.write('üîß Todos los recursos est√°n configurados como gratuitos (valor = 0.00)')
